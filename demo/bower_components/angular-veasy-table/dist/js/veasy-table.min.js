angular.module("veasyTable",["ui.bootstrap","veasyTable.templates"]).directive("veasyTable",["$window","$filter","$templateCache","$timeout","$modal",function(a,b,c,d,e){return{restrict:"EA",replace:!0,templateUrl:"veasy-table.html",scope:{list:"=",selectedItems:"=",config:"="},link:function(c,d,f,g){var h=function(){i(),c.isLoading=!0,c.config.checkbox||(c.config.checkbox={}),c.config.pagination||(c.config.pagination={}),c.config.filter||(c.config.filter={}),c.config.columnFilter||(c.config.columnFilter={}),c.config.ordenation||(c.config.ordenation={}),c.config.resizable||(c.config.resizable={}),c.config.checkbox.enable||(c.config.checkbox.enable=!1,c.config.checkbox.size=0),c.config.pagination.enable||(c.config.pagination.enable=!1,c.config.pagination.currentPage=0,c.config.pagination.itemsPerPage=c.list.length||0),c.config.filter.enable||(c.config.filter.enable=!1,c.config.filter.conditional=!1),c.config.columnFilter.enable||(c.config.columnFilter.enable=!1),c.config.ordenation.enable||(c.config.ordenation.enable=!1),c.config.resizable.enable||(c.config.resizable.enable=!1,c.config.resizable.minimumSize=30),c.predicate="",c.reverse=!1,c.query="",c.condition="AND",c.colspan=1,c.visibleColumns=[],c.paginatedList=[],c.filteredList=[],c.cbs=[],c.search();for(var a=0;a<c.filteredList.length;a++)c.cbs[a]=!1;c.dragColIndex,c.initialPosition,c.direction,c.tableWidth=angular.element("#"+c.config.id).width()},i=function(){a.addEventListener("resize",function(){c.tableWidth=angular.element("#"+c.config.id).width(),n(),c.$apply()})};c.checkboxSize=function(){return c.config.checkbox.size+"px"},c.getIndex=function(a){return c.filteredList.indexOf(a)},c.checkRow=function(a){var b=c.getIndex(a),d=c.cbs[b],e=c.selectedItems.indexOf(a);d&&-1===e&&c.selectedItems.push(a),d&&e>-1&&(c.selectedItems.splice(e,1),c.cbs[b]=!1),!d&&e>-1&&c.selectedItems.splice(e,1)},c.checkAllRows=function(a){angular.forEach(c.paginatedList,function(b){angular.forEach(b,function(b,d){c.cbs[c.getIndex(b)]=a,c.checkRow(b)})})};var j=function(){angular.forEach(c.selectedItems,function(a){c.cbs[c.getIndex(a)]=!0})};c.changeCondition=function(a){c.condition=a,c.search()},c.search=function(){c.filteredList=b("filter")(c.list,function(a){switch(c.condition){case"AND":return k(a);case"OR":return l(a)}}),c.config.ordenation.enable&&""!==c.predicate&&(c.filteredList=b("orderBy")(c.filteredList,c.predicate,c.reverse)),c.config.pagination.currentPage=0,c.generatePages()};var k=function(a){var b="";angular.forEach(c.config.columns,function(c){b+=" "+a[c.value]});var d=[],e=angular.lowercase(c.query).split(" ");return angular.forEach(e,function(a){d.push(b.toString().toLowerCase().indexOf(a)>=0)}),-1!==d.indexOf(!1)?!1:!0},l=function(a){var b=angular.lowercase(c.query).split(" "),d=[];return angular.forEach(c.config.columns,function(c){var e=a[c.value]?a[c.value]:"";angular.forEach(b,function(a){d.push(e.toString().toLowerCase().indexOf(a)>=0)})}),d.indexOf(!0)>=0?!0:!1};c.generatePages=function(){c.paginatedList=[];for(var a=0;a<c.filteredList.length;a++){var b=a/c.config.pagination.itemsPerPage;a%c.config.pagination.itemsPerPage===0?!isNaN(b)&&isFinite(b)&&(c.paginatedList[Math.floor(b)]=[c.filteredList[a]]):!isNaN(b)&&isFinite(b)&&c.paginatedList[Math.floor(b)].push(c.filteredList[a])}},c.sort=function(a){c.config.ordenation.enable&&(c.predicate===a&&(c.reverse=!c.reverse),c.predicate=a,""!==c.predicate&&(c.filteredList=b("orderBy")(c.filteredList,c.predicate,c.reverse),c.generatePages()))},c.orderByIcon=function(a,b){if(!c.config.ordenation)return!1;switch(a){case"asc":return c.predicate===b&&c.reverse;case"desc":return c.predicate===b&&!c.reverse;default:return!0}},c.pages=function(){if(c.config.pagination.enable){var a=c.config.pagination.currentPage,b=c.paginatedList.length-1,d=5,e=[];a>b-d&&(a=b-d+1);for(var f=a;a+d>f;f++)f>=0&&e.push(f);return j(),e}},c.prevPage=function(){c.config.pagination.currentPage>0&&c.config.pagination.currentPage--},c.nextPage=function(){c.config.pagination.currentPage<c.paginatedList.length-1&&c.config.pagination.currentPage++},c.setPage=function(a){c.config.pagination.currentPage=a},c.prevPageDisabled=function(){return 0===c.config.pagination.currentPage?"disabled":""},c.nextPageDisabled=function(){return c.config.pagination.currentPage===c.paginatedList.length-1?"disabled":""},c.$watchCollection("list",function(a){c.search(),c.list.length>0&&(c.config.pagination.enable||(c.config.pagination.itemsPerPage=c.list.length,c.generatePages()),m(),c.isLoading=!1)});var m=function(){var a=[];angular.forEach(c.config.columns,function(b){b.show&&a.push(b)}),c.visibleColumns=a,c.colspan=c.visibleColumns.length+1,n()};c.openColumnFilter=function(a){var b=e.open({templateUrl:"veasy-table-modal.html",controller:"ColumnFilterController",size:a,resolve:{columns:function(){return c.config.columns}}});b.result.then(function(a){c.visibleColumns=a,c.colspan=c.visibleColumns.length+1,n()},function(){})};var n=function(){c.tableWidth=angular.element("#"+c.config.id).width(),angular.forEach(c.visibleColumns,function(a,b){c.visibleColumns[b].size=(c.tableWidth-c.config.checkbox.size)/c.visibleColumns.length})};c.onDrag=function(a,b){c.dragging=!0,c.initialPosition=o(a).x,c.dragColIndex=b},c.onLeave=function(a){c.onStopDrag(a)},c.onStopDrag=function(a){c.dragging=!1,c.dragColIndex=void 0},c.onMove=function(a){if(c.dragging){var b=c.dragColIndex,d=c.visibleColumns[b].size,e=c.visibleColumns[b-1].size,f=p(a),g=o(a).x;g>c.initialPosition&&(c.direction=!0),g<c.initialPosition&&(c.direction=!1);var h=q(c.initialPosition,g,f.left);(d+h<c.config.resizable.minimumSize||e-h<c.config.resizable.minimumSize)&&(h=0),r(h,b)}};var o=function(a){a=a||window.event;var b=a.pageX,c=a.pageY;return void 0===b&&(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:b,y:c}},p=function(a){return document.getElementById(c.config.id).getBoundingClientRect()},q=function(a,b,d){c.direction=!0,a>b&&(c.direction=!1);var e=Math.abs(parseInt(a-d)),f=Math.abs(parseInt(b-d));return c.initialPosition=b,e-f},r=function(a,b){c.visibleColumns[b].size+=a,c.visibleColumns[b-1].size-=a};h()}}}]).controller("ColumnFilterController",["$scope","$modalInstance","columns",function(a,b,c){var d=function(){a.visibleColumns=[],a.columns=c,a.setVisibleColumns()};a.ok=function(){b.close(a.visibleColumns)},a.cancel=function(){b.dismiss("cancel")},a.setVisibleColumns=function(){var b=[];angular.forEach(a.columns,function(a){a.show&&b.push(a)}),a.visibleColumns=b},d()}]);
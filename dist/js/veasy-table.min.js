angular.module("veasyTable",["ui.bootstrap","veasyTable.templates"]).directive("veasyTable",["$window","$filter","$templateCache","$timeout","$modal",function(a,b,c,d,e){return{restrict:"EA",replace:!0,templateUrl:"veasy-table.html",scope:{list:"=",selectedItems:"=",config:"="},link:function(a,c,f,g){var h=function(){a.isLoading=!0,a.tableSize=0,a.minimumTableSize=400,a.query="",a.condition="AND",a.paginatedList=[],a.cbs=[],i(),a.dragControlListeners={accept:function(a,b){return!0},itemMoved:function(a){},orderChanged:function(a){},containment:"#board"},a.$watch(function(){return angular.element("#"+a.config.id).width()},function(b){b>a.minimumTableSize&&(a.tableSize=b)}),a.$watch(function(){return a.config.columns},function(b){b&&b.length>0&&l(b,a.config.resizable.minimumSize)}),a.$watch(function(){return a.list},function(b){b&&b.length>0&&(angular.forEach(b,function(b,c){a.cbs[c]=!1}),a.config.pagination.enable?a.currentPage=a.config.pagination.currentPage:(a.config.pagination.itemsPerPage=b.length,a.currentPage=0),m(b),a.isLoading=!1)})},i=function(){a.config||(a.config={}),a.config.id||(a.config.id="veasy-table"),a.config.columns||(a.config.columns=[]),a.config.checkbox||(a.config.checkbox={}),a.config.checkbox.enable||(a.config.checkbox.enable=!1),a.config.checkbox.size||(a.config.checkbox.size=20),a.config.resizable||(a.config.resizable={}),a.config.resizable.enable||(a.config.resizable.enable=!1),a.config.resizable.minimumSize||(a.config.resizable.minimumSize=1),a.config.pagination||(a.config.pagination={}),a.config.pagination.enable||(a.config.pagination.enable=!1),a.config.pagination.enable||(a.config.pagination.currentPage=0),a.config.pagination.enable||(a.config.pagination.itemsPerPage=10)};a.onClickRow=function(b){if(a.config.events.onClickRow){var c=angular.copy(b);c.$$hashKey&&delete c.$$hashKey,a.config.events.onClickRow(c)}};var j=function(b){if(a.config.events.onApplyColumnFilter){var c=A();angular.forEach(b,function(a,b){a.size=100*a.size/c}),a.config.events.onApplyColumnFilter(b)}},k=function(b){a.config.events.onTableStateChange&&(a.resizeTimer&&d.cancel(a.resizeTimer),a.resizeTimer=d(function(){a.config.events.onTableStateChange(b)},4e3))},l=function(b,c){a.config.columnFilter.autoOpen&&o(b).length<1&&a.openColumnFilter(a.config.columnFilter.modalSize),a.visibleColumns=n(angular.copy(b),angular.copy(c)),E(a.visibleColumns.length)},m=function(b){v(b),a.totalOfItems=b.length},n=function(a,b){var c=o(a);return c=p(c,b)},o=function(a){return a.filter(function(a){return a.show})},p=function(a,b){var c=[],d=a.reduce(function(a,d,e,f){return d.show?d.size&&d.size>=b?(c.push(e),a+d.size):(d.size=b,a+d.size):(d.size&&delete d.size,a)},0);if(c.length<1)return r(A(),a);var e=100-d,f=c[c.length-1];return!a[f].size||a[f].size+e<b?r(A(),a):(a[f].size+=e,q(A(),a))},q=function(a,b){return angular.forEach(b,function(b){b.size=Math.round(a*b.size)/100}),b},r=function(a,b){return angular.forEach(b,function(c,d){c.size=Math.round(a/b.length*100)/100}),b};a.changeCondition=function(b,c){a.condition=b,a.search(b,c)},a.changeQuery=function(b,c){a.queryBusy&&d.cancel(a.queryBusy),a.queryBusy=d(function(){a.search(b,c)},a.config.filter.delay)},a.search=function(b,c){var d=s(b,c);a.totalOfItems=d.length,a.currentPage=0,m(d)};var s=function(c,d){a.searching=!0;var e=b("filter")(a.list,function(a){switch(c){case"AND":return t(a,d);case"OR":return u(a,d)}});return a.searching=!1,e},t=function(b,c){var d="";angular.forEach(a.visibleColumns,function(a){d+=" "+b[a.value]});var e=[],f=angular.lowercase(c).split(" ");return angular.forEach(f,function(a){e.push(d.toString().toLowerCase().indexOf(a)>=0)}),-1!==e.indexOf(!1)?!1:!0},u=function(b,c){var d=angular.lowercase(c).split(" "),e=[];return angular.forEach(a.visibleColumns,function(a){var c=b[a.value]?b[a.value]:"";angular.forEach(d,function(a){e.push(c.toString().toLowerCase().indexOf(a)>=0)})}),e.indexOf(!0)>=0?!0:!1},v=function(b){a.paginatedList=[];for(var c=0;c<b.length;c++){var d=c/a.config.pagination.itemsPerPage;c%a.config.pagination.itemsPerPage===0?!isNaN(d)&&isFinite(d)&&(a.paginatedList[Math.floor(d)]=[b[c]]):!isNaN(d)&&isFinite(d)&&a.paginatedList[Math.floor(d)].push(b[c])}};a.pages=function(){if(a.config.pagination.enable){var b=a.currentPage,c=a.paginatedList.length-1,d=5,e=[];b>c-d&&(b=c-d+1);for(var f=b;b+d>f;f++)f>=0&&e.push(f);return e}},a.setPage=function(b){a.currentPage=b,y(a.list)},a.nextPage=function(){a.currentPage<a.paginatedList.length-1&&a.setPage(a.currentPage+1)},a.prevPage=function(){a.currentPage>0&&a.setPage(a.currentPage-1)},a.nextPageDisabled=function(){return a.currentPage==a.paginatedList.length-1?"disabled":""},a.prevPageDisabled=function(){return 0==a.currentPage?"disabled":""},a.onDragStart=function(b,c){a.initialPosition=C(b).x,a.draggableColumnIndex=c,a.dragging=!0},a.onDragStop=function(b,c){a.draggableColumnIndex=void 0,a.dragging&&k(angular.copy(c)),a.dragging=!1},a.onMove=function(b,c){if(a.dragging){var d=angular.copy(a.draggableColumnIndex),e=c[d].size,f=c[d-1].size,g=D(),h=B(b),i=C(b).x;i>a.initialPosition&&(a.direction=!0),i<a.initialPosition&&(a.direction=!1);var j=w(a.initialPosition,i,h.left);(g>e+j||g>f-j)&&(j=0),x(j,d)}};var w=function(b,c,d){a.direction=!0,b>c&&(a.direction=!1);var e=Math.abs(parseInt(b-d)),f=Math.abs(parseInt(c-d));return a.initialPosition=c,e-f},x=function(b,c){a.visibleColumns[c].size+=b,a.visibleColumns[c-1].size-=b};a.sort=function(c,d){a.config.sort.enable&&(a.predicate===c&&(a.reverse=!a.reverse),a.predicate=c,""!==a.predicate&&(d=b("orderBy")(d,a.predicate,a.reverse)))},a.orderByIcon=function(b,c){if(!a.config.sort.enable)return!1;switch(b){case"asc":return a.predicate===c&&a.reverse;case"desc":return a.predicate===c&&!a.reverse;default:return!0}},a.openColumnFilter=function(b){var c=e.open({templateUrl:"veasy-table-modal.html",controller:"ColumnFilterController",size:b,resolve:{config:function(){return a.config}}});c.result.then(function(b){l(b,a.config.resizable.minimumSize),j(angular.copy(b))})},a.getIndex=function(a,b){return a.indexOf(b)},a.onCheckRow=function(b,c){var d=a.cbs[b];z(a.selectedItems,c)?d?(a.cbs[b]=!1,a.selectedItems.splice(a.selectedItems.indexOf(c),1)):a.selectedItems.splice(a.selectedItems.indexOf(c),1):d&&a.selectedItems.push(c)},a.checkOrUncheckAllRows=function(b,c){a.selectedItems=[],angular.forEach(a.cbs,function(b,d){a.cbs[d]=angular.copy(c)}),c&&angular.forEach(b,function(b,c){angular.forEach(b,function(b,c){a.selectedItems.push(b)})})};var y=function(b){angular.forEach(a.selectedItems,function(c,d){a.cbs[a.getIndex(b,c)]=!0})},z=function(a,b){return a.indexOf(b)>=0},A=function(){var b=angular.copy(a.tableSize);return a.config.checkbox.enable&&(b-=a.config.checkbox.size),b},B=function(b){return document.getElementById(a.config.id).getBoundingClientRect()},C=function(a){a=a||window.event;var b=a.pageX,c=a.pageY;return void 0===b&&(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:b,y:c}},D=function(){var b=angular.copy(a.tableSize);return a.config.resizable.minimumSize*b/100};a.getCheckboxSizeInPixel=function(){return a.config.checkbox.size+"px"};var E=function(b){a.config.checkbox.enable&&(b+=1),a.colspan=b};h()}}}]).controller("ColumnFilterController",["$scope","$modalInstance","config",function(a,b,c){var d=function(){a.config=c,a.columns=c.columns,a.visibleColumns=e(a.columns)};a.ok=function(){var c=e(a.columns);b.close(c)},a.cancel=function(){b.dismiss("cancel")};var e=function(a){var b=[];return angular.forEach(a,function(a){a.$$hashKey&&delete a.$$hashKey,a.size&&delete a.size,a.show&&b.push(a)}),b};d()}]);
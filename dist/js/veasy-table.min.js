angular.module("veasyTable",["ui.bootstrap","veasyTable.templates"]).directive("veasyTable",["$window","$filter","$templateCache","$timeout","$modal",function(a,b,c,d,e){return{restrict:"EA",replace:!0,templateUrl:"veasy-table.html",scope:{list:"=",selectedItems:"=",config:"="},link:function(c,f,g,h){var i=function(){j(),c.isLoading=!0,k(),l(),m(),n(),o(),p(),q(),r(),c.dragColIndex,c.initialPosition,c.direction,c.predicate="",c.reverse=!1,c.query="",c.condition="AND",c.colspan=1,c.visibleColumns=[],c.paginatedList=[],c.filteredList=[],c.cbs=[],c.search();for(var a=0;a<c.filteredList.length;a++)c.cbs[a]=!1;c.tableWidth=angular.element("#"+c.config.id).width()},j=function(){a.addEventListener("resize",function(){c.tableWidth=angular.element("#"+c.config.id).width(),w(),c.$apply()})},k=function(){c.config.checkbox||(c.config.checkbox={enable:!1,size:0}),c.config.checkbox.enable&&(!c.config.checkbox.size||c.config.checkbox.size<20)&&(c.config.checkbox.size=20)},l=function(){c.config.pagination||(c.config.pagination={enable:!1,currentPage:0,itemsPerPage:c.list.length||10}),c.config.pagination.enable&&(!c.config.pagination.currentPage||c.config.pagination.currentPage<=0?c.config.pagination.currentPage=0:c.config.pagination.currentPage-=1,c.config.pagination.itemsPerPage||(c.config.pagination.itemsPerPage=10))},m=function(){c.config.filter||(c.config.filter={enable:!1,conditional:!1}),c.config.filter.enable&&(c.config.filter.conditional||(c.config.filter.conditional=!1))},n=function(){c.config.columnFilter||(c.config.columnFilter={enable:!1})},o=function(){c.config.sort||(c.config.sort={enable:!1})},p=function(){c.config.resizable||(c.config.resizable={enable:!1,minimumSize:30}),c.config.resizable.enable&&(!c.config.resizable.minimumSize||c.config.resizable.minimumSize<30)&&(c.config.resizable.minimumSize=30)},q=function(){c.config.events||(c.config.events={}),c.config.events.onClickRow||(c.config.events.onClickRow=function(a){})},r=function(){c.config.translate||(c.config.translate={}),c.config.translate.filter||(c.config.translate.filter={}),c.config.translate.filter.by||(c.config.translate.filter.by="Filter by..."),c.config.translate.filter.and||(c.config.translate.filter.and="AND"),c.config.translate.filter.or||(c.config.translate.filter.or="OR"),c.config.translate.pagination||(c.config.translate.pagination={}),c.config.translate.pagination.itemsByPage||(c.config.translate.pagination.itemsByPage="Items by Page"),c.config.translate.pagination.totalItems||(c.config.translate.pagination.totalItems="Total Items"),c.config.translate.columnFilter||(c.config.translate.columnFilter={}),c.config.translate.columnFilter.title||(c.config.translate.columnFilter.title="Which columns you want to display?"),c.config.translate.columnFilter.okButton||(c.config.translate.columnFilter.okButton="Ok"),c.config.translate.columnFilter.cancelButton||(c.config.translate.columnFilter.cancelButton="Cancel")};c.checkboxSize=function(){return c.config.checkbox.size+"px"},c.getIndex=function(a){return c.filteredList.indexOf(a)},c.checkRow=function(a){var b=c.getIndex(a),d=c.cbs[b],e=c.selectedItems.indexOf(a);d&&-1===e&&c.selectedItems.push(a),d&&e>-1&&(c.selectedItems.splice(e,1),c.cbs[b]=!1),!d&&e>-1&&c.selectedItems.splice(e,1)},c.checkAllRows=function(a){angular.forEach(c.paginatedList,function(b){angular.forEach(b,function(b,d){c.cbs[c.getIndex(b)]=a,c.checkRow(b)})})};var s=function(){angular.forEach(c.selectedItems,function(a){c.cbs[c.getIndex(a)]=!0})};c.changeQuery=function(){c.busy&&d.cancel(c.busy),c.searching=!0,c.busy=d(function(){c.search(),c.searching=!1},c.config.filter.delay)},c.changeCondition=function(a){c.condition=a,c.search()},c.search=function(){c.filteredList=b("filter")(c.list,function(a){switch(c.condition){case"AND":return t(a);case"OR":return u(a)}}),c.config.sort.enable&&""!==c.predicate&&(c.filteredList=b("orderBy")(c.filteredList,c.predicate,c.reverse)),c.isLoading||(c.config.pagination.currentPage=0),c.generatePages()};var t=function(a){var b="";angular.forEach(c.config.columns,function(c){b+=" "+a[c.value]});var d=[],e=angular.lowercase(c.query).split(" ");return angular.forEach(e,function(a){d.push(b.toString().toLowerCase().indexOf(a)>=0)}),-1!==d.indexOf(!1)?!1:!0},u=function(a){var b=angular.lowercase(c.query).split(" "),d=[];return angular.forEach(c.config.columns,function(c){var e=a[c.value]?a[c.value]:"";angular.forEach(b,function(a){d.push(e.toString().toLowerCase().indexOf(a)>=0)})}),d.indexOf(!0)>=0?!0:!1};c.generatePages=function(){c.paginatedList=[];for(var a=0;a<c.filteredList.length;a++){var b=a/c.config.pagination.itemsPerPage;a%c.config.pagination.itemsPerPage===0?!isNaN(b)&&isFinite(b)&&(c.paginatedList[Math.floor(b)]=[c.filteredList[a]]):!isNaN(b)&&isFinite(b)&&c.paginatedList[Math.floor(b)].push(c.filteredList[a])}},c.sort=function(a){c.config.sort.enable&&(c.predicate===a&&(c.reverse=!c.reverse),c.predicate=a,""!==c.predicate&&(c.filteredList=b("orderBy")(c.filteredList,c.predicate,c.reverse),c.generatePages()))},c.orderByIcon=function(a,b){if(!c.config.sort)return!1;switch(a){case"asc":return c.predicate===b&&c.reverse;case"desc":return c.predicate===b&&!c.reverse;default:return!0}},c.pages=function(){if(c.config.pagination.enable){var a=c.config.pagination.currentPage,b=c.paginatedList.length-1,d=5,e=[];a>b-d&&(a=b-d+1);for(var f=a;a+d>f;f++)f>=0&&e.push(f);return s(),e}},c.prevPage=function(){c.config.pagination.currentPage>0&&c.config.pagination.currentPage--},c.nextPage=function(){c.config.pagination.currentPage<c.paginatedList.length-1&&c.config.pagination.currentPage++},c.setPage=function(a){c.config.pagination.currentPage=a},c.prevPageDisabled=function(){return 0===c.config.pagination.currentPage?"disabled":""},c.nextPageDisabled=function(){return c.config.pagination.currentPage===c.paginatedList.length-1?"disabled":""},c.$watchCollection("list",function(a){c.search(),c.list.length>0&&(c.config.pagination.enable||(c.config.pagination.itemsPerPage=c.list.length,c.generatePages()),v(),c.isLoading=!1)});var v=function(){var a=[];angular.forEach(c.config.columns,function(b){b.show&&a.push(b)}),c.visibleColumns=a,c.colspan=c.visibleColumns.length,c.config.checkbox.enable&&(c.colspan+=1),w()};c.openColumnFilter=function(a){var b=e.open({templateUrl:"veasy-table-modal.html",controller:"ColumnFilterController",size:a,resolve:{config:function(){return c.config}}});b.result.then(function(a){c.visibleColumns=angular.copy(a),c.colspan=c.visibleColumns.length+1,w()})},c.dragControlListeners={accept:function(a,b){return!0},itemMoved:function(a){},orderChanged:function(a){},containment:"#board"};var w=function(){c.tableWidth=angular.element("#"+c.config.id).width(),angular.forEach(c.visibleColumns,function(a,b){c.visibleColumns[b].size=(c.tableWidth-c.config.checkbox.size)/c.visibleColumns.length})};c.onDrag=function(a,b){c.dragging=!0,c.initialPosition=x(a).x,c.dragColIndex=b},c.onLeave=function(a){c.onStopDrag(a)},c.onStopDrag=function(a){c.dragging=!1,c.dragColIndex=void 0},c.onMove=function(a){if(c.dragging){var b=c.dragColIndex,d=c.visibleColumns[b].size,e=c.visibleColumns[b-1].size,f=y(a),g=x(a).x;g>c.initialPosition&&(c.direction=!0),g<c.initialPosition&&(c.direction=!1);var h=z(c.initialPosition,g,f.left);(d+h<c.config.resizable.minimumSize||e-h<c.config.resizable.minimumSize)&&(h=0),A(h,b)}};var x=function(a){a=a||window.event;var b=a.pageX,c=a.pageY;return void 0===b&&(b=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,c=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),{x:b,y:c}},y=function(a){return document.getElementById(c.config.id).getBoundingClientRect()},z=function(a,b,d){c.direction=!0,a>b&&(c.direction=!1);var e=Math.abs(parseInt(a-d)),f=Math.abs(parseInt(b-d));return c.initialPosition=b,e-f},A=function(a,b){c.visibleColumns[b].size+=a,c.visibleColumns[b-1].size-=a};c.onClickRow=function(a){var b=angular.copy(a);delete b.$$hashKey,c.config.events.onClickRow(b)},i()}}}]).controller("ColumnFilterController",["$scope","$modalInstance","config",function(a,b,c){var d=function(){a.config=c,a.columns=c.columns,a.visibleColumns=[],a.setVisibleColumns()};a.ok=function(){a.setVisibleColumns(a.columns),b.close(a.visibleColumns)},a.cancel=function(){b.dismiss("cancel")},a.setVisibleColumns=function(b){var c=[];angular.forEach(b,function(a){a.show&&c.push(a)}),a.visibleColumns=c},d()}]);